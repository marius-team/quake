

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Query Coordinator &mdash; Quake 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/css/modify.css?v=fab1bd98" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=d45e8c67"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Quake
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_guide.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture/architecture.html">Quake Index Architecture</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Quake</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Query Coordinator</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/coordinator.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="query-coordinator">
<span id="id1"></span><h1>Query Coordinator<a class="headerlink" href="#query-coordinator" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>This document describes the NUMA‑aware design for the QueryCoordinator. In this design, the coordinator distributes query work to worker threads that scan index partitions in parallel. The design focuses on reducing memory latency by using NUMA‑aware allocation and thread affinity, minimizing synchronization overhead via per‑core resource pools and job queues, and uses adaptive partition scanning (APS) to enable early termination.</p>
<p>The design aims to:</p>
<ul class="simple">
<li><p>Minimize memory latency by pinning data (e.g. top‑K buffers, partitions) to the same cores that process them.</p></li>
<li><p>Reduce synchronization overhead by using per‑core resource pools and per‑core job queues.</p></li>
<li><p>Achieve nearly linear scalability with the number of cores while matching the serial scan performance for a single worker.</p></li>
<li><p>Maintain APS behavior (adaptive early termination) by tracking recall locally and merging results globally.</p></li>
</ul>
</section>
<section id="coordinator-architecture-diagram">
<h2>Coordinator Architecture Diagram<a class="headerlink" href="#coordinator-architecture-diagram" title="Link to this heading"></a></h2>
<pre  class="mermaid">
        %%{
  init: {
    &quot;theme&quot;: &quot;default&quot;,
    &quot;themeVariables&quot;: {
      &quot;fontSize&quot;: &quot;20px&quot;,
      &quot;fontFamily&quot;: &quot;Arial&quot;
      &quot;fontWeight&quot;: &quot;bold&quot;
    }
  }
}%%

flowchart LR

%% External inputs/nodes
QIN[&quot;Input Query Vectors&quot;]
PSCAN[&quot;Partition IDs&quot;]
R[&quot;Final Results&quot;]

%% The main QueryCoordinator subgraph
subgraph QC[&quot;QueryCoordinator&quot;]
    direction LR

    %% Core 1
    subgraph Core1[&quot;Core 1&quot;]
        direction TB
        JQ1[[&quot;Job Queue&quot;]]
        QBA1[/Query Buffers/]
        IP1[&quot;Index Partitions&quot;]
        WT1(&quot;Scan Thread&quot;)
        LTK1((&quot;Local TopK&quot;))
    end

    %% Core n
    subgraph CoreN[&quot;Core n&quot;]
        direction TB
        JQN[[&quot;Job Queue&quot;]]
        QBAN[/Query Buffers/]
        IPN[&quot;Index Partitions&quot;]
        WTN(&quot;Scan Thread&quot;)
        LTKn((&quot;Local TopK&quot;))
    end

    GTopk((&quot;Global TopK&quot;))

    %% APS module that checks the global buffer and signals early termination
    APS[&quot;Adaptive Partition Scanning (APS)&quot;]
end

%% Edges from input queries to each core's query buffers
QIN --&gt;|memcpy| QBA1
QIN --&gt;|memcpy| QBAN

PSCAN --&gt;|enqueue| JQ1
PSCAN --&gt;|enqueue| JQN

%% Inside each core, show the flow
JQ1 --&gt;|dequeue| WT1
QBA1 --&gt;|read| WT1
IP1 --&gt;|scan| WT1
WT1 --&gt;|write| LTK1

JQN --&gt;|dequeue| WTN
QBAN --&gt;|read| WTN
IPN --&gt;|scan| WTN
WTN --&gt;|write| LTKn

%% Merge local topK into global topK
LTK1 --&gt;|merge| GTopk
LTKn --&gt;|merge| GTopk

%% APS periodically checks global buffer for recall progress
GTopk &lt;--&gt;|check recall| APS
APS --&gt;|signal early termination| GTopk

%% Finally, global topk to results
GTopk --&gt;|return| R

%% Optional styling for clarity
style QC fill:#fff7e6,stroke:#666,stroke-width:8px;
style QIN fill:#ccf,stroke:#333,stroke-width:1px;
style R fill:#ffecb3,stroke:#333,stroke-width:1px;
style Core1 fill:#fff,stroke:#999,stroke-width:1px;
style CoreN fill:#fff,stroke:#999,stroke-width:1px;
style LTK1 fill:#eef,stroke:#333,stroke-width:1px,stroke-dasharray:2 2;
style LTKn fill:#eef,stroke:#333,stroke-width:1px,stroke-dasharray:2 2;
style GTopk fill:#eef,stroke:#333,stroke-width:1px,stroke-dasharray:2 2;
style APS fill:#fff,stroke:#999,stroke-width:1px,stroke-dasharray:3 3;
    </pre></section>
<section id="key-components">
<h2>Key Components<a class="headerlink" href="#key-components" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>QueryCoordinator</strong>
The main class that distributes query work, manages worker threads, and merges local results from all cores into a final search result.</p></li>
<li><p><strong>CoreResources</strong>
A per‑core structure that contains:</p>
<ul>
<li><p>A pool of preallocated Top‑K buffers that are allocated using NUMA‑aware routines and pinned to local memory.</p></li>
<li><p>A local aggregator (query buffer) to collect intermediate results.</p></li>
<li><p>A dedicated job queue that holds scan jobs for that core.</p></li>
</ul>
</li>
<li><p><strong>ScanJob Structure</strong>
Each unit of work (a ScanJob) encapsulates:</p>
<ul>
<li><p>Whether the job is batched or single‑query.</p></li>
<li><p>The partition ID (which is pinned to a specific core).</p></li>
<li><p>The number of neighbors (<code class="docutils literal notranslate"><span class="pre">k</span></code>) to return.</p></li>
<li><p>A pointer to the query vector(s).</p></li>
<li><p>Global query IDs and, for batched jobs, the number of queries.</p></li>
</ul>
</li>
<li><p><strong>Global Aggregator</strong>
A coordinator-managed Top‑K buffer that merges per‑core local aggregators to produce the final search result.</p></li>
</ul>
</section>
<section id="workflow-and-job-distribution">
<h2>Workflow and Job Distribution<a class="headerlink" href="#workflow-and-job-distribution" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p><strong>Distribute Partitions to Cores:</strong>
The PartitionManager assigns partitions to cores based on partition size. Each partition’s memory is allocated on the correct NUMA node using NUMA‑aware routines.</p></li>
<li><p><strong>Per‑Core Job Queues:</strong>
The QueryCoordinator creates a per‑core job queue inside each CoreResources structure. For each partition local to a core, a ScanJob is created (either for single-query or batched queries) and enqueued into that core’s job queue.</p></li>
<li><p><strong>Worker Processing:</strong>
Each worker thread (one per core) executes a stateless worker function that:</p>
<ul class="simple">
<li><p>Sets affinity to the core it belongs to.</p></li>
<li><p>Dequeues jobs from its core’s job queue.</p></li>
<li><p>Processes each job (invoking the appropriate scan function).</p></li>
<li><p>Merges results into the core’s local aggregator.</p></li>
<li><p>Decrements a global atomic counter (or per‑core counter) and signals a condition variable for global coordination.</p></li>
</ul>
</li>
<li><p><strong>Global Aggregation:</strong>
The coordinator periodically merges local aggregators into a global Top‑K buffer.</p></li>
<li><p><strong>APS and Early Termination:</strong>
The APS module periodically checks the global Top‑K buffer to determine if the recall target has been met. If so, it signals worker threads to stop scanning.</p></li>
</ol>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading"></a></h2>
<p>By integrating per‑core resource pools, NUMA‑aware allocation, and affinity‑pinned worker threads, this design aims to minimize memory latency and synchronization overhead while preserving the APS behavior. The coordinator distributes work into per‑core job queues and merges local results into a global aggregator, providing scalability and efficient parallel query processing.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Jason Mohoney.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>